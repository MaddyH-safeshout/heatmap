<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeShout - Student Safeguarding Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'safeshout-primary': '#2563EB',
                        'safeshout-error': '#DC2626',
                        'safeshout-warning': '#F59E0B', 
                        'safeshout-success': '#059669'
                    },
                    fontFamily: {
                        'sans': ['Roboto', 'ui-sans-serif', 'system-ui']
                    }
                }
            }
        }
    </script>
    <style>
        .page-container { display: none; }
        .page-container.active { display: block; }
        .gradient-bg { background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <!-- Header (always visible) -->
    <header class="bg-white shadow-sm border-b border-gray-200 h-16 flex items-center px-6 z-50 relative">
        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-safeshout-primary rounded-lg flex items-center justify-center">
                    <svg class="text-white w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h1 class="text-xl font-semibold text-gray-900 cursor-pointer" onclick="showPage('dashboard')">SafeShout</h1>
            </div>
            <span class="text-gray-500">|</span>
            <span class="text-gray-600 font-medium">Safeguarding Intelligence</span>
        </div>
        
        <div class="ml-auto flex items-center space-x-4">
            <button class="relative p-2 text-gray-600 hover:text-gray-900 rounded-lg hover:bg-gray-100" data-testid="button-notifications">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path>
                </svg>
                <span class="absolute -top-1 -right-1 bg-safeshout-error text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">3</span>
            </button>
            
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                    <svg class="text-gray-600 w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <span class="text-gray-700 font-medium" data-testid="text-username">Student User</span>
            </div>
        </div>
    </header>

    <!-- Dashboard Page -->
    <div id="dashboard-page" class="page-container active">
        <div class="flex h-[calc(100vh-4rem)]">
            <!-- Sidebar -->
            <div class="w-80 bg-white shadow-lg border-r border-gray-200 flex flex-col">
                <!-- Map Type Toggle -->
                <div class="p-4 border-b border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-900 mb-3">Map View</h3>
                    <div class="flex rounded-lg bg-gray-100 p-1">
                        <button id="school-toggle" class="flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors bg-safeshout-primary text-white" onclick="toggleMapType('school')" data-testid="button-school-view">
                            School Onsite
                        </button>
                        <button id="community-toggle" class="flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors text-gray-600 hover:text-gray-900" onclick="toggleMapType('community')" data-testid="button-community-view">
                            Community
                        </button>
                    </div>
                </div>

                <!-- Priority Filters -->
                <div class="p-4 border-b border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-900 mb-3">Priority Levels</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div id="priority-high" class="p-3 rounded-lg cursor-pointer transition-all bg-red-50 hover:bg-red-100" onclick="togglePriorityFilter('high')" data-testid="filter-high-priority">
                            <div class="text-2xl font-bold text-safeshout-error" id="high-count">96</div>
                            <div class="text-xs text-red-600">High Priority</div>
                        </div>
                        
                        <div id="priority-medium" class="p-3 rounded-lg cursor-pointer transition-all bg-orange-50 hover:bg-orange-100" onclick="togglePriorityFilter('medium')" data-testid="filter-medium-priority">
                            <div class="text-2xl font-bold text-safeshout-warning" id="medium-count">61</div>
                            <div class="text-xs text-orange-600">Medium Priority</div>
                        </div>
                        
                        <div id="priority-low" class="p-3 rounded-lg cursor-pointer transition-all bg-green-50 hover:bg-green-100" onclick="togglePriorityFilter('low')" data-testid="filter-low-priority">
                            <div class="text-2xl font-bold text-safeshout-success" id="low-count">18</div>
                            <div class="text-xs text-green-600">Low Priority</div>
                        </div>
                        
                        <div id="priority-total" class="p-3 rounded-lg cursor-pointer transition-all bg-blue-50 hover:bg-blue-100" onclick="clearPriorityFilters()" data-testid="filter-total-concerns">
                            <div class="text-2xl font-bold text-safeshout-primary" id="total-count" data-testid="stat-total-concerns">175</div>
                            <div class="text-xs text-blue-600">Total Concerns</div>
                        </div>
                    </div>
                    <div id="clear-filters-container" class="mt-3 hidden">
                        <button onclick="clearPriorityFilters()" class="w-full px-4 py-2 text-xs border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors" data-testid="button-clear-priority-filters">
                            Clear Priority Filters
                        </button>
                    </div>
                </div>

                <!-- Time Filter -->
                <div class="p-4 border-b border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-900 mb-3">Time Period</h3>
                    <select id="time-period-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-safeshout-primary focus:border-transparent" data-testid="select-time-period">
                        <option value="day">Last 24 Hours</option>
                        <option value="week" selected>Last 7 Days</option>
                        <option value="month">Last 30 Days</option>
                        <option value="quarter">Last 90 Days</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>

                <!-- Concern Themes -->
                <div class="p-4 border-b border-gray-200 flex-1 overflow-y-auto">
                    <h3 class="text-sm font-semibold text-gray-900 mb-3">Concern Themes</h3>
                    <div class="space-y-2">
                        <label class="flex items-center space-x-2 text-sm">
                            <input type="checkbox" class="concern-type-checkbox rounded" value="Online Safety" data-testid="checkbox-online-safety">
                            <span class="text-gray-700 flex-1">Online Safety</span>
                            <span class="ml-auto text-white px-2 py-1 rounded-full text-xs bg-safeshout-error">36</span>
                        </label>
                        
                        <label class="flex items-center space-x-2 text-sm">
                            <input type="checkbox" class="concern-type-checkbox rounded" value="Self-Harm" data-testid="checkbox-self-harm">
                            <span class="text-gray-700 flex-1">Self-Harm</span>
                            <span class="ml-auto text-white px-2 py-1 rounded-full text-xs bg-safeshout-error">33</span>
                        </label>
                        
                        <label class="flex items-center space-x-2 text-sm">
                            <input type="checkbox" class="concern-type-checkbox rounded" value="Mental Health" data-testid="checkbox-mental-health">
                            <span class="text-gray-700 flex-1">Mental Health</span>
                            <span class="ml-auto text-white px-2 py-1 rounded-full text-xs bg-safeshout-warning">29</span>
                        </label>
                        
                        <label class="flex items-center space-x-2 text-sm">
                            <input type="checkbox" class="concern-type-checkbox rounded" value="Physical Safety" data-testid="checkbox-physical-safety">
                            <span class="text-gray-700 flex-1">Physical Safety</span>
                            <span class="ml-auto text-white px-2 py-1 rounded-full text-xs bg-safeshout-warning">28</span>
                        </label>
                        
                        <label class="flex items-center space-x-2 text-sm">
                            <input type="checkbox" class="concern-type-checkbox rounded" value="Abuse" data-testid="checkbox-abuse">
                            <span class="text-gray-700 flex-1">Abuse</span>
                            <span class="ml-auto text-white px-2 py-1 rounded-full text-xs bg-safeshout-warning">26</span>
                        </label>
                        
                        <label class="flex items-center space-x-2 text-sm">
                            <input type="checkbox" class="concern-type-checkbox rounded" value="Bullying" data-testid="checkbox-bullying">
                            <span class="text-gray-700 flex-1">Bullying</span>
                            <span class="ml-auto text-white px-2 py-1 rounded-full text-xs bg-safeshout-warning">21</span>
                        </label>
                        
                        <label class="flex items-center space-x-2 text-sm">
                            <input type="checkbox" class="concern-type-checkbox rounded" value="Substance Misuse" data-testid="checkbox-substance-misuse">
                            <span class="text-gray-700 flex-1">Substance Misuse</span>
                            <span class="ml-auto text-white px-2 py-1 rounded-full text-xs bg-safeshout-success">1</span>
                        </label>
                        
                        <label class="flex items-center space-x-2 text-sm">
                            <input type="checkbox" class="concern-type-checkbox rounded" value="Criminal Exploitation" data-testid="checkbox-criminal-exploitation">
                            <span class="text-gray-700 flex-1">Criminal Exploitation</span>
                            <span class="ml-auto text-white px-2 py-1 rounded-full text-xs bg-safeshout-success">1</span>
                        </label>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="p-4 border-t border-gray-200">
                    <button onclick="openAddConcernModal()" class="w-full bg-safeshout-primary text-white hover:bg-blue-700 mb-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center" data-testid="button-add-concern">
                        <svg class="mr-2 w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                        </svg>
                        Add New Concern
                    </button>
                    
                    <button onclick="showPage('data-analytics')" class="w-full mb-2 bg-gradient-to-r from-blue-50 to-purple-50 hover:from-blue-100 hover:to-purple-100 border-blue-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center border" data-testid="button-data-analytics">
                        <svg class="mr-2 w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
                        </svg>
                        Data Analytics
                    </button>
                    
                    <button onclick="showPage('area-intelligence')" class="w-full mb-2 bg-gradient-to-r from-purple-50 to-indigo-50 hover:from-purple-100 hover:to-indigo-100 border-purple-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center border" data-testid="button-area-intelligence">
                        <svg class="mr-2 w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                        </svg>
                        Area Risk Intelligence
                    </button>
                    
                    <button onclick="showPage('safety-checkin')" class="w-full mb-2 bg-gradient-to-r from-green-50 to-emerald-50 hover:from-green-100 hover:to-emerald-100 border-green-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center border" data-testid="button-safety-checkin">
                        <svg class="mr-2 w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Safety Check-in
                    </button>
                    
                    <button onclick="exportData()" class="w-full bg-gradient-to-r from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 border-gray-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center border" data-testid="button-export-data">
                        <svg class="mr-2 w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                        Export Data
                    </button>
                </div>
            </div>
            
            <!-- Map Container -->
            <div class="flex-1 relative">
                <div id="map" class="w-full h-full"></div>
                
                <!-- Map Controls -->
                <div class="absolute top-4 right-4 z-[1000] space-y-2">
                    <button onclick="refreshMapData()" class="bg-white shadow-lg rounded-lg p-3 hover:bg-gray-50 transition-colors" title="Update Data">
                        <svg class="w-5 h-5 text-gray-700" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                    
                    <button onclick="toggleHeatmap()" class="bg-white shadow-lg rounded-lg p-3 hover:bg-gray-50 transition-colors" title="Toggle Heatmap">
                        <svg class="w-5 h-5 text-gray-700" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Analytics Page -->
    <div id="data-analytics-page" class="page-container">
        <div class="min-h-screen gradient-bg p-6">
            <div class="max-w-7xl mx-auto space-y-6">
                
                <!-- Header -->
                <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
                            <svg class="h-8 w-8 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
                            </svg>
                            Data Analytics
                        </h1>
                        <p class="text-gray-600 mt-2">Comprehensive AI-powered safeguarding intelligence and review system</p>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <!-- Time Range Selector -->
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-600">Time Range:</span>
                            <div class="flex rounded-lg border border-gray-200 bg-white">
                                <button class="px-3 py-1.5 text-sm font-medium transition-colors text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-l-lg" onclick="setAnalyticsTimeRange('day')" data-testid="button-timerange-day">
                                    Last 24h
                                </button>
                                <button class="px-3 py-1.5 text-sm font-medium transition-colors bg-blue-600 text-white" onclick="setAnalyticsTimeRange('week')" data-testid="button-timerange-week">
                                    Last Week
                                </button>
                                <button class="px-3 py-1.5 text-sm font-medium transition-colors text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-r-lg" onclick="setAnalyticsTimeRange('month')" data-testid="button-timerange-month">
                                    Last Month
                                </button>
                            </div>
                        </div>
                        
                        <button onclick="refreshAnalyticsData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center" data-testid="button-refresh-analytics">
                            <svg class="h-4 w-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
                            </svg>
                            Refresh Data
                        </button>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="border-b border-gray-200">
                        <nav class="flex">
                            <button onclick="showAnalyticsTab('live-analysis')" id="tab-live-analysis" class="px-6 py-3 text-sm font-medium border-b-2 border-blue-600 text-blue-600 bg-blue-50 flex items-center gap-2">
                                <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                Live AI Analysis
                            </button>
                            <button onclick="showAnalyticsTab('intelligence-reviews')" id="tab-intelligence-reviews" class="px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900 hover:border-gray-300 flex items-center gap-2">
                                <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                                </svg>
                                Intelligence Reviews
                            </button>
                        </nav>
                    </div>

                    <!-- Live Analysis Tab Content -->
                    <div id="live-analysis-content" class="analytics-tab-content p-6">
                        
                        <!-- Real-time Alerts -->
                        <div class="bg-white border-0 shadow-lg rounded-lg mb-6">
                            <div class="bg-gradient-to-r from-red-500 to-red-600 text-white p-4 rounded-t-lg">
                                <h3 class="text-lg font-semibold flex items-center gap-2">
                                    <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                    Real-time Safeguarding Alerts
                                </h3>
                            </div>
                            <div class="p-6">
                                <div class="text-center py-8">
                                    <div class="text-green-600 text-6xl mb-4">✓</div>
                                    <p class="text-gray-600 font-medium">All Clear - No Active Alerts</p>
                                    <p class="text-gray-500 text-sm mt-2">The system is monitoring 10 Leeds areas with no critical alerts at this time.</p>
                                </div>
                            </div>
                        </div>

                        <!-- AI Analysis Overview -->
                        <div class="bg-white border-0 shadow-lg rounded-lg">
                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-t-lg">
                                <h3 class="text-lg font-semibold flex items-center gap-2">
                                    <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
                                    </svg>
                                    AI Intelligence Overview
                                </h3>
                            </div>
                            <div class="p-6">
                                
                                <!-- Key Metrics -->
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                    <div class="bg-gray-50 p-4 rounded-lg text-center">
                                        <div class="text-3xl font-bold text-blue-600">3</div>
                                        <div class="text-sm text-gray-600">Total Incidents</div>
                                    </div>
                                    <div class="bg-red-50 p-4 rounded-lg text-center">
                                        <div class="text-3xl font-bold text-red-600">0</div>
                                        <div class="text-sm text-gray-600">High Risk Areas</div>
                                    </div>
                                    <div class="bg-orange-50 p-4 rounded-lg text-center">
                                        <div class="text-3xl font-bold text-orange-600">2</div>
                                        <div class="text-sm text-gray-600">Medium Risk Areas</div>
                                    </div>
                                    <div class="bg-green-50 p-4 rounded-lg text-center">
                                        <div class="text-3xl font-bold text-green-600">2</div>
                                        <div class="text-sm text-gray-600">Improving Areas</div>
                                    </div>
                                </div>

                                <!-- Areas Summary -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    
                                    <!-- Medium Risk Areas -->
                                    <div class="bg-orange-50 border border-orange-200 p-4 rounded-lg">
                                        <h4 class="font-semibold text-orange-800 mb-3">Medium Risk Areas</h4>
                                        
                                        <div class="space-y-3">
                                            <div class="bg-white p-3 rounded border border-orange-200">
                                                <div class="flex items-center justify-between mb-2">
                                                    <span class="font-medium text-orange-900">Headingley</span>
                                                    <span class="bg-orange-500 text-white px-2 py-1 rounded text-xs">MEDIUM</span>
                                                </div>
                                                <p class="text-sm text-orange-700 mb-2">Trending worse - weekend activity patterns</p>
                                                <div class="text-xs text-orange-600">
                                                    <strong>Key Pattern:</strong> 100% of incidents occur during weekends
                                                </div>
                                            </div>
                                            
                                            <div class="bg-white p-3 rounded border border-orange-200">
                                                <div class="flex items-center justify-between mb-2">
                                                    <span class="font-medium text-orange-900">Beeston</span>
                                                    <span class="bg-orange-500 text-white px-2 py-1 rounded text-xs">MEDIUM</span>
                                                </div>
                                                <p class="text-sm text-orange-700 mb-2">Transport hub vulnerabilities identified</p>
                                                <div class="text-xs text-orange-600">
                                                    <strong>Key Pattern:</strong> 1 high-priority incidents (50%)
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Weekly Trends -->
                                    <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                                        <h4 class="font-semibold text-blue-800 mb-3">Weekly Intelligence Summary</h4>
                                        
                                        <div class="space-y-3">
                                            <div class="flex justify-between items-center">
                                                <span class="text-sm text-blue-700">Total Incidents:</span>
                                                <span class="font-semibold text-blue-900">3</span>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-sm text-blue-700">Weekly Change:</span>
                                                <span class="font-semibold text-green-600">-25%</span>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-sm text-blue-700">Escalation Areas:</span>
                                                <span class="font-semibold text-blue-900">0</span>
                                            </div>
                                        </div>

                                        <div class="mt-4">
                                            <h5 class="text-sm font-medium text-blue-800 mb-2">Top Concern Types:</h5>
                                            <div class="space-y-1">
                                                <div class="flex justify-between text-sm">
                                                    <span class="text-blue-700">Abuse</span>
                                                    <span class="text-blue-900 font-medium">1 ↑</span>
                                                </div>
                                                <div class="flex justify-between text-sm">
                                                    <span class="text-blue-700">Substance Misuse</span>
                                                    <span class="text-blue-900 font-medium">1 ↑</span>
                                                </div>
                                                <div class="flex justify-between text-sm">
                                                    <span class="text-blue-700">Bullying</span>
                                                    <span class="text-blue-900 font-medium">1 ↑</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Intelligence Reviews Tab Content -->
                    <div id="intelligence-reviews-content" class="analytics-tab-content p-6" style="display: none;">
                        <div class="text-center py-12">
                            <svg class="h-16 w-16 text-gray-400 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                            </svg>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">Intelligence Reviews</h3>
                            <p class="text-gray-600">Historical intelligence review system with detailed analysis reports</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Area Intelligence Page -->
    <div id="area-intelligence-page" class="page-container">
        <div class="min-h-screen gradient-bg p-6">
            <div class="max-w-7xl mx-auto space-y-6">
                
                <!-- Header -->
                <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
                            <svg class="h-8 w-8 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                            </svg>
                            Area Risk Intelligence
                        </h1>
                        <p class="text-gray-600 mt-2">Comprehensive safeguarding overview by geographical area</p>
                    </div>
                </div>

                <!-- Area Overview Grid -->
                <div id="area-overview-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Safety Check-in Page -->
    <div id="safety-checkin-page" class="page-container">
        <div class="min-h-screen gradient-bg p-6">
            <div class="max-w-7xl mx-auto space-y-6">
                
                <!-- Header -->
                <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
                            <svg class="h-8 w-8 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Safety Check-in
                        </h1>
                        <p class="text-gray-600 mt-2">Termly safety check-in for proactive safeguarding</p>
                    </div>
                </div>

                <!-- Safety Check-in Interface -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <!-- Instructions Card -->
                    <div class="bg-blue-50 border border-blue-200 p-6 rounded-lg">
                        <h2 class="text-xl font-semibold text-blue-800 mb-4">Student Safety Mapping - Spring 2025</h2>
                        <p class="text-blue-700 mb-4">Help us identify areas where you feel unsafe so we can improve our community safety measures.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h3 class="font-semibold text-blue-800 mb-2">How it works:</h3>
                                <ul class="text-sm text-blue-700 space-y-1">
                                    <li>• Click on map areas where you feel unsafe</li>
                                    <li>• Rate your safety level (1-5 scale)</li>
                                    <li>• Describe what makes you feel unsafe</li>
                                    <li>• Submit anonymously or with your name</li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="font-semibold text-blue-800 mb-2">Your input helps with:</h3>
                                <ul class="text-sm text-blue-700 space-y-1">
                                    <li>• Environmental improvements</li>
                                    <li>• Enhanced security measures</li>
                                    <li>• Community safety planning</li>
                                    <li>• Preventive interventions</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Safety Check-in Form -->
                    <div class="bg-white border border-gray-200 p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Submit Safety Feedback</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Map Type</label>
                                <div class="flex rounded-lg bg-gray-100 p-1">
                                    <button class="flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors bg-safeshout-primary text-white">
                                        School Onsite
                                    </button>
                                    <button class="flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors text-gray-600 hover:text-gray-900">
                                        Community
                                    </button>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Safety Level (1 = Very Unsafe, 5 = Very Safe)</label>
                                <input type="range" min="1" max="5" value="3" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>Very Unsafe</span>
                                    <span>Neutral</span>
                                    <span>Very Safe</span>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Time of Day</label>
                                <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-safeshout-primary focus:border-transparent">
                                    <option value="">Select time...</option>
                                    <option value="morning">Morning (8am-12pm)</option>
                                    <option value="afternoon">Afternoon (12pm-5pm)</option>
                                    <option value="evening">Evening (5pm-8pm)</option>
                                    <option value="night">Night (8pm+)</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">What makes you feel unsafe?</label>
                                <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-safeshout-primary focus:border-transparent" rows="3" placeholder="Describe the situation, environment, or factors that affect your safety..."></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Suggestions for improvement</label>
                                <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-safeshout-primary focus:border-transparent" rows="2" placeholder="How could this area be made safer?"></textarea>
                            </div>

                            <div class="flex items-center">
                                <input type="checkbox" id="anonymous" class="rounded border-gray-300 text-safeshout-primary focus:ring-safeshout-primary">
                                <label for="anonymous" class="ml-2 text-sm text-gray-700">Submit anonymously</label>
                            </div>

                            <button class="w-full bg-safeshout-primary text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                Submit Safety Check-in
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Concern Modal -->
    <div id="add-concern-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold">Add New Safeguarding Concern</h2>
                    <button onclick="closeAddConcernModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>

                <form class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Concern Type</label>
                        <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-safeshout-primary focus:border-transparent">
                            <option value="">Select concern type...</option>
                            <option value="Online Safety">Online Safety</option>
                            <option value="Self-Harm">Self-Harm</option>
                            <option value="Mental Health">Mental Health</option>
                            <option value="Physical Safety">Physical Safety</option>
                            <option value="Abuse">Abuse</option>
                            <option value="Bullying">Bullying</option>
                            <option value="Substance Misuse">Substance Misuse</option>
                            <option value="Criminal Exploitation">Criminal Exploitation</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                        <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-safeshout-primary focus:border-transparent">
                            <option value="">Select priority...</option>
                            <option value="high">High Priority</option>
                            <option value="medium">Medium Priority</option>
                            <option value="low">Low Priority</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                        <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-safeshout-primary focus:border-transparent" placeholder="e.g., Science Block, Main Hall, Chapel Allerton">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-safeshout-primary focus:border-transparent" rows="4" placeholder="Please provide details about the concern..."></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Reported By (Optional)</label>
                        <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-safeshout-primary focus:border-transparent" placeholder="Leave blank for anonymous reporting">
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeAddConcernModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-safeshout-primary text-white rounded-lg hover:bg-blue-700 transition-colors">
                            Submit Concern
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let map;
        let markersGroup;
        let heatmapLayer;
        let currentMapType = 'school';
        let currentFilters = {
            priorities: [],
            concernTypes: [],
            timePeriod: 'week'
        };

        // Sample data matching your actual React app data
        const concernsData = {
            school: [
                {
                    id: 1,
                    type: "Self-Harm",
                    priority: "high",
                    location: "Science Block",
                    latitude: 53.8321,
                    longitude: -1.5036,
                    description: "Student reported self-harm incidents in bathroom facilities",
                    reportedBy: "Teacher",
                    status: "open",
                    mapType: "school"
                },
                {
                    id: 2,
                    type: "Online Safety",
                    priority: "high",
                    location: "Computer Lab",
                    latitude: 53.8325,
                    longitude: -1.5040,
                    description: "Inappropriate online behavior reported during IT lesson",
                    reportedBy: "IT Staff",
                    status: "open",
                    mapType: "school"
                },
                {
                    id: 3,
                    type: "Bullying",
                    priority: "medium",
                    location: "Main Playground",
                    latitude: 53.8318,
                    longitude: -1.5035,
                    description: "Physical confrontation between students",
                    reportedBy: "Student",
                    status: "investigating",
                    mapType: "school"
                }
            ],
            community: [
                {
                    id: 4,
                    type: "Criminal Exploitation",
                    priority: "high",
                    location: "Chapel Allerton High Street",
                    latitude: 53.8250,
                    longitude: -1.5400,
                    description: "Young person approached by adults offering money for activities",
                    reportedBy: "Community Member",
                    status: "open",
                    mapType: "community"
                },
                {
                    id: 5,
                    type: "Substance Misuse",
                    priority: "high",
                    location: "Harehills Park",
                    latitude: 53.8120,
                    longitude: -1.5200,
                    description: "Drug paraphernalia found in children's play area",
                    reportedBy: "Park Visitor",
                    status: "investigating",
                    mapType: "community"
                },
                {
                    id: 6,
                    type: "Physical Safety",
                    priority: "medium",
                    location: "Beeston Transport Hub",
                    latitude: 53.7800,
                    longitude: -1.5650,
                    description: "Poor lighting and isolated areas creating safety concerns",
                    reportedBy: "Student",
                    status: "open",
                    mapType: "community"
                }
            ]
        };

        // Area intelligence data
        const areaIntelligenceData = [
            {
                areaName: "Roundhay School - All Areas",
                coordinates: { lat: 53.8308, lng: -1.5097 },
                mapType: "school",
                ragRating: "red",
                riskScore: 60,
                trendDirection: "increasing",
                topPattern: "Self-Harm incidents represent 24% of all concerns (12 out of 50 reports)",
                totalConcerns: 50,
                priorityBreakdown: { high: 23, medium: 20, low: 7 },
                lastUpdated: "2025-08-26T09:22:33.194Z",
                recentActivity: "50 incidents in past 7 days, 23 high priority"
            },
            {
                areaName: "Other Community Areas",
                coordinates: { lat: 53.8208, lng: -1.5197 },
                mapType: "community",
                ragRating: "red",
                riskScore: 64,
                trendDirection: "increasing",
                topPattern: "Mental Health incidents represent 19% of all concerns (18 out of 93 reports)",
                totalConcerns: 93,
                priorityBreakdown: { high: 52, medium: 33, low: 8 },
                lastUpdated: "2025-08-26T09:22:33.194Z",
                recentActivity: "22 incidents in past 7 days, 16 high priority"
            },
            {
                areaName: "Roundhay/Oakwood Area",
                coordinates: { lat: 53.8208, lng: -1.5197 },
                mapType: "community",
                ragRating: "red",
                riskScore: 65,
                trendDirection: "increasing",
                topPattern: "Online Safety incidents represent 30% of all concerns (3 out of 10 reports)",
                totalConcerns: 10,
                priorityBreakdown: { high: 6, medium: 3, low: 1 },
                lastUpdated: "2025-08-26T09:22:33.194Z",
                recentActivity: "2 incidents in past 7 days, 2 high priority"
            },
            {
                areaName: "Hyde Park/Headingley Area",
                coordinates: { lat: 53.8208, lng: -1.5197 },
                mapType: "community",
                ragRating: "red",
                riskScore: 66,
                trendDirection: "increasing",
                topPattern: "Physical Safety incidents represent 27% of all concerns (3 out of 11 reports)",
                totalConcerns: 11,
                priorityBreakdown: { high: 7, medium: 3, low: 1 },
                lastUpdated: "2025-08-26T09:22:33.194Z",
                recentActivity: "2 incidents in past 7 days, 2 high priority"
            },
            {
                areaName: "Harehills Area",
                coordinates: { lat: 53.8208, lng: -1.5197 },
                mapType: "community",
                ragRating: "red",
                riskScore: 69,
                trendDirection: "increasing",
                topPattern: "Online Safety incidents represent 36% of all concerns (4 out of 11 reports)",
                totalConcerns: 11,
                priorityBreakdown: { high: 8, medium: 2, low: 1 },
                lastUpdated: "2025-08-26T09:22:33.194Z",
                recentActivity: "3 incidents in past 7 days, 2 high priority"
            }
        ];

        // Initialize the application
        function initializeApp() {
            initializeMap();
            loadAreaIntelligence();
        }

        // Page navigation
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page-container').forEach(page => {
                page.classList.remove('active');
            });

            // Show selected page
            const targetPage = document.getElementById(`${pageId}-page`);
            if (targetPage) {
                targetPage.classList.add('active');
            }

            // Special handling for different pages
            if (pageId === 'dashboard') {
                // Reinitialize map if needed
                setTimeout(() => {
                    if (map) {
                        map.invalidateSize();
                        updateMapMarkers();
                    }
                }, 100);
            } else if (pageId === 'area-intelligence') {
                loadAreaIntelligence();
            }
        }

        // Map functions
        function initializeMap() {
            if (map) {
                map.remove();
            }

            const schoolBounds = [[53.8300, -1.5100], [53.8380, -1.5000]];
            const communityBounds = [[53.7500, -1.6500], [53.8800, -1.4000]];
            
            const bounds = currentMapType === 'school' ? schoolBounds : communityBounds;
            const center = currentMapType === 'school' ? [53.8340, -1.5050] : [53.8008, -1.5491];
            
            map = L.map('map').setView(center, currentMapType === 'school' ? 16 : 11);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            map.fitBounds(bounds);
            
            // Initialize marker group
            markersGroup = L.markerClusterGroup({
                maxClusterRadius: 50,
                iconCreateFunction: function(cluster) {
                    const markers = cluster.getAllChildMarkers();
                    const priorities = markers.map(m => m.options.priority);
                    const highCount = priorities.filter(p => p === 'high').length;
                    const mediumCount = priorities.filter(p => p === 'medium').length;
                    
                    let className = 'marker-cluster-';
                    if (highCount > 0) className += 'red';
                    else if (mediumCount > 0) className += 'yellow';
                    else className += 'green';
                    
                    return L.divIcon({
                        html: `<div><span>${markers.length}</span></div>`,
                        className: `marker-cluster ${className}`,
                        iconSize: L.point(40, 40)
                    });
                }
            });
            
            map.addLayer(markersGroup);
            
            updateMapMarkers();
            updateHeatmap();
        }

        function toggleMapType(type) {
            currentMapType = type;
            
            // Update button states
            document.getElementById('school-toggle').className = type === 'school' 
                ? 'flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors bg-safeshout-primary text-white'
                : 'flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors text-gray-600 hover:text-gray-900';
            
            document.getElementById('community-toggle').className = type === 'community' 
                ? 'flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors bg-safeshout-primary text-white'
                : 'flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors text-gray-600 hover:text-gray-900';
            
            initializeMap();
        }

        function updateMapMarkers() {
            if (!markersGroup) return;
            
            markersGroup.clearLayers();
            
            const data = concernsData[currentMapType] || [];
            const filteredData = data.filter(concern => {
                const priorityMatch = currentFilters.priorities.length === 0 || currentFilters.priorities.includes(concern.priority);
                const typeMatch = currentFilters.concernTypes.length === 0 || currentFilters.concernTypes.includes(concern.type);
                return priorityMatch && typeMatch;
            });
            
            filteredData.forEach(concern => {
                const iconColor = concern.priority === 'high' ? 'red' : concern.priority === 'medium' ? 'orange' : 'green';
                
                const marker = L.marker([concern.latitude, concern.longitude], {
                    priority: concern.priority,
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background-color: ${iconColor}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                        iconSize: [20, 20]
                    })
                });
                
                marker.bindPopup(`
                    <div class="p-2">
                        <h3 class="font-semibold text-sm">${concern.type}</h3>
                        <p class="text-xs text-gray-600 mb-1">${concern.location}</p>
                        <p class="text-xs mb-2">${concern.description}</p>
                        <div class="flex justify-between text-xs">
                            <span class="px-2 py-1 rounded ${concern.priority === 'high' ? 'bg-red-100 text-red-800' : concern.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">${concern.priority}</span>
                            <span class="text-gray-500">${concern.status}</span>
                        </div>
                    </div>
                `);
                
                markersGroup.addLayer(marker);
            });
        }

        function updateHeatmap() {
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
            }
            
            const data = concernsData[currentMapType] || [];
            const filteredData = data.filter(concern => {
                const priorityMatch = currentFilters.priorities.length === 0 || currentFilters.priorities.includes(concern.priority);
                const typeMatch = currentFilters.concernTypes.length === 0 || currentFilters.concernTypes.includes(concern.type);
                return priorityMatch && typeMatch;
            });
            
            const heatData = filteredData.map(concern => {
                const intensity = concern.priority === 'high' ? 0.9 : concern.priority === 'medium' ? 0.6 : 0.3;
                return [concern.latitude, concern.longitude, intensity];
            });
            
            if (heatData.length > 0) {
                heatmapLayer = L.heatLayer(heatData, {
                    radius: 25,
                    blur: 15,
                    maxZoom: 17,
                    gradient: {
                        0.0: '#00E676',
                        0.3: '#8BC34A', 
                        0.45: '#CDDC39',
                        0.55: '#FFEB3B',
                        0.65: '#FF9800',
                        0.8: '#FF5722',
                        1.0: '#D32F2F'
                    }
                }).addTo(map);
            }
        }

        // Filter functions
        function togglePriorityFilter(priority) {
            const index = currentFilters.priorities.indexOf(priority);
            const element = document.getElementById(`priority-${priority}`);
            
            if (index === -1) {
                currentFilters.priorities.push(priority);
                element.classList.remove('bg-red-50', 'hover:bg-red-100', 'bg-orange-50', 'hover:bg-orange-100', 'bg-green-50', 'hover:bg-green-100');
                if (priority === 'high') {
                    element.classList.add('bg-red-100', 'ring-2', 'ring-red-500');
                } else if (priority === 'medium') {
                    element.classList.add('bg-orange-100', 'ring-2', 'ring-orange-500');
                } else if (priority === 'low') {
                    element.classList.add('bg-green-100', 'ring-2', 'ring-green-500');
                }
            } else {
                currentFilters.priorities.splice(index, 1);
                element.classList.remove('bg-red-100', 'ring-2', 'ring-red-500', 'bg-orange-100', 'ring-orange-500', 'bg-green-100', 'ring-green-500');
                if (priority === 'high') {
                    element.classList.add('bg-red-50', 'hover:bg-red-100');
                } else if (priority === 'medium') {
                    element.classList.add('bg-orange-50', 'hover:bg-orange-100');
                } else if (priority === 'low') {
                    element.classList.add('bg-green-50', 'hover:bg-green-100');
                }
            }
            
            const clearContainer = document.getElementById('clear-filters-container');
            if (currentFilters.priorities.length > 0) {
                clearContainer.classList.remove('hidden');
            } else {
                clearContainer.classList.add('hidden');
            }
            
            updateMapMarkers();
            updateHeatmap();
        }

        function clearPriorityFilters() {
            currentFilters.priorities = [];
            
            ['high', 'medium', 'low'].forEach(priority => {
                const element = document.getElementById(`priority-${priority}`);
                element.classList.remove('bg-red-100', 'ring-2', 'ring-red-500', 'bg-orange-100', 'ring-orange-500', 'bg-green-100', 'ring-green-500');
                if (priority === 'high') {
                    element.classList.add('bg-red-50', 'hover:bg-red-100');
                } else if (priority === 'medium') {
                    element.classList.add('bg-orange-50', 'hover:bg-orange-100');
                } else if (priority === 'low') {
                    element.classList.add('bg-green-50', 'hover:bg-green-100');
                }
            });
            
            document.getElementById('clear-filters-container').classList.add('hidden');
            updateMapMarkers();
            updateHeatmap();
        }

        // Concern type filters
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('concern-type-checkbox')) {
                const type = e.target.value;
                if (e.target.checked) {
                    if (!currentFilters.concernTypes.includes(type)) {
                        currentFilters.concernTypes.push(type);
                    }
                } else {
                    const index = currentFilters.concernTypes.indexOf(type);
                    if (index > -1) {
                        currentFilters.concernTypes.splice(index, 1);
                    }
                }
                updateMapMarkers();
                updateHeatmap();
            }
        });

        // Analytics functions
        function showAnalyticsTab(tabId) {
            // Update tab buttons
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                if (tab.id === `tab-${tabId}`) {
                    tab.className = 'px-6 py-3 text-sm font-medium border-b-2 border-blue-600 text-blue-600 bg-blue-50 flex items-center gap-2';
                } else {
                    tab.className = 'px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900 hover:border-gray-300 flex items-center gap-2';
                }
            });

            // Show/hide content
            document.querySelectorAll('.analytics-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            const targetContent = document.getElementById(`${tabId}-content`);
            if (targetContent) {
                targetContent.style.display = 'block';
            }
        }

        function setAnalyticsTimeRange(range) {
            // Update button states
            document.querySelectorAll('[data-testid^="button-timerange-"]').forEach(btn => {
                btn.className = 'px-3 py-1.5 text-sm font-medium transition-colors text-gray-600 hover:text-blue-600 hover:bg-blue-50' + 
                    (btn.dataset.testid === 'button-timerange-day' ? ' rounded-l-lg' : '') +
                    (btn.dataset.testid === 'button-timerange-month' ? ' rounded-r-lg' : '');
            });

            const selectedBtn = document.querySelector(`[data-testid="button-timerange-${range}"]`);
            if (selectedBtn) {
                selectedBtn.className = 'px-3 py-1.5 text-sm font-medium transition-colors bg-blue-600 text-white' +
                    (range === 'day' ? ' rounded-l-lg' : '') +
                    (range === 'month' ? ' rounded-r-lg' : '');
            }
        }

        function refreshAnalyticsData() {
            // Simulate data refresh
            console.log('Refreshing analytics data...');
        }

        // Area Intelligence functions
        function loadAreaIntelligence() {
            const grid = document.getElementById('area-overview-grid');
            if (!grid) return;

            grid.innerHTML = '';

            areaIntelligenceData.forEach((area, idx) => {
                const getRagColor = (rating) => {
                    switch (rating) {
                        case 'red': return 'bg-red-500 text-white';
                        case 'amber': return 'bg-orange-500 text-white';
                        case 'green': return 'bg-green-500 text-white';
                        default: return 'bg-gray-500 text-white';
                    }
                };

                const getTrendIcon = (direction) => {
                    switch (direction) {
                        case 'increasing': return '<svg class="h-4 w-4 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>';
                        case 'decreasing': return '<svg class="h-4 w-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M14.707 12.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>';
                        default: return '<svg class="h-4 w-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>';
                    }
                };

                const cardHtml = `
                    <div class="border-0 shadow-lg hover:shadow-xl transition-shadow cursor-pointer bg-white rounded-lg">
                        <div class="${area.mapType === 'school' ? 'bg-gradient-to-r from-blue-500 to-blue-600' : 'bg-gradient-to-r from-green-500 to-green-600'} text-white p-4 rounded-t-lg">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-lg font-semibold">${area.areaName}</span>
                                </div>
                                <span class="px-2 py-1 rounded text-xs ${getRagColor(area.ragRating)}">
                                    ${area.ragRating.toUpperCase()}
                                </span>
                            </div>
                        </div>
                        <div class="p-4">
                            <!-- Key Metrics Row -->
                            <div class="grid grid-cols-3 gap-3 mb-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-gray-900">${area.riskScore}</div>
                                    <div class="text-xs text-gray-600">Risk Score</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-gray-900">${area.totalConcerns}</div>
                                    <div class="text-xs text-gray-600">Total</div>
                                </div>
                                <div class="text-center flex flex-col items-center">
                                    ${getTrendIcon(area.trendDirection)}
                                    <div class="text-xs text-gray-600 mt-1 capitalize">${area.trendDirection}</div>
                                </div>
                            </div>

                            <!-- Priority Summary -->
                            <div class="grid grid-cols-3 gap-1 mb-4 text-xs">
                                <div class="text-center p-1.5 bg-red-50 rounded border border-red-200">
                                    <div class="font-bold text-red-800">${area.priorityBreakdown.high}</div>
                                    <div class="text-red-600">High</div>
                                </div>
                                <div class="text-center p-1.5 bg-orange-50 rounded border border-orange-200">
                                    <div class="font-bold text-orange-800">${area.priorityBreakdown.medium}</div>
                                    <div class="text-orange-600">Med</div>
                                </div>
                                <div class="text-center p-1.5 bg-green-50 rounded border border-green-200">
                                    <div class="font-bold text-green-800">${area.priorityBreakdown.low}</div>
                                    <div class="text-green-600">Low</div>
                                </div>
                            </div>

                            <!-- Top Pattern -->
                            <div class="mb-4">
                                <div class="text-xs font-medium text-gray-700 mb-1">Key Pattern:</div>
                                <div class="text-xs text-gray-600 bg-blue-50 p-2 rounded border border-blue-200 line-clamp-2">
                                    ${area.topPattern}
                                </div>
                            </div>

                            <!-- Action Button -->
                            <button class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-sm font-medium transition-colors flex items-center justify-center">
                                <svg class="h-4 w-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                                    <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
                                </svg>
                                View Intelligence
                            </button>
                        </div>
                    </div>
                `;

                grid.innerHTML += cardHtml;
            });
        }

        // Modal functions
        function openAddConcernModal() {
            document.getElementById('add-concern-modal').classList.remove('hidden');
        }

        function closeAddConcernModal() {
            document.getElementById('add-concern-modal').classList.add('hidden');
        }

        // Utility functions
        function refreshMapData() {
            updateMapMarkers();
            updateHeatmap();
        }

        function toggleHeatmap() {
            if (heatmapLayer && map.hasLayer(heatmapLayer)) {
                map.removeLayer(heatmapLayer);
            } else {
                updateHeatmap();
            }
        }

        function exportData() {
            const data = concernsData[currentMapType] || [];
            const filteredData = data.filter(concern => {
                const priorityMatch = currentFilters.priorities.length === 0 || currentFilters.priorities.includes(concern.priority);
                const typeMatch = currentFilters.concernTypes.length === 0 || currentFilters.concernTypes.includes(concern.type);
                return priorityMatch && typeMatch;
            });

            const blob = new Blob([JSON.stringify(filteredData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `safeshout-concerns-${currentMapType}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>